<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes" />
  <title>Visor de Cartones de Bingo</title>
  <style>
    /* Estilos generales */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #333;
      overflow: hidden;
    }

    /* Barra de herramientas */
    #toolbar {
      display: flex;
      gap: 10px;
      padding: 10px;
      flex-wrap: wrap;
      background: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      justify-content: center;
      position: relative;
      z-index: 10;
    }

    #toolbar button,
    #toolbar select,
    #toolbar input[type="color"],
    #toolbar input[type="range"] {
      padding: 8px 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #toolbar button:hover {
      background: #e0e0e0;
    }

    #toolbar input[type="color"] {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 50%;
    }

    #toolbar input[type="range"] {
      width: 100px;
    }

    /* Canvas */
    canvas {
      touch-action: none;
      background: #fff;
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Pantalla completa */
    .fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 999;
      background: #fff;
    }

    /* Animaciones */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Barra de herramientas -->
  <div id="toolbar">
    <label><input type="color" id="colorPicker" value="#ff0000"></label>
    <label>
      <input type="range" id="brushSizeSlider" min="5" max="300" value="120" step="5">
      <span id="brushSizeValue">120px</span>
    </label>
    <label>Trans.:
      <input type="range" id="opacityRange" min="0.1" max="1" step="0.1" value="0.6">
    </label>
    <button onclick="undo()">‚Ü©</button>
    <button onclick="redo()">‚Ü™</button>
    <button onclick="save()">üíæ</button>
    <label>
      <button onclick="toggleDropdown()">üî¢</button>
      <select id="cartonDropdown" onchange="loadSelectedCarton()" style="display:none;"></select>
    </label>
    <label>
      <input type="file" id="fileInput" accept="image/*" style="display:none;">
      <button onclick="document.getElementById('fileInput').click()">üìÅ</button>
    </label>
    <button onclick="toggleFullscreen()">‚õ∂</button>
  </div>

  <!-- Canvas -->
  <canvas id="canvas"></canvas>

  <script>
    // Variables globales
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let drawing = false;
    let paths = [];
    let redoStack = [];
    let currentPath = [];
    let color = document.getElementById("colorPicker").value;
    let size = +document.getElementById("brushSizeSlider").value;
    let opacity = +document.getElementById("opacityRange").value;
    let baseImage = new Image();
    let imageWidth, imageHeight, scale;
    let isChanged = false;

    // Configuraci√≥n inicial del canvas
    function setupCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight - document.getElementById("toolbar").offsetHeight;
      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("mouseout", stopDrawing);
      canvas.addEventListener("touchstart", startDrawing);
      canvas.addEventListener("touchmove", draw);
      canvas.addEventListener("touchend", stopDrawing);

      // Cargar im√°genes desde JSON
      fetch('cartones/list.json')
        .then(response => response.json())
        .then(data => {
          const dropdown = document.getElementById("cartonDropdown");
          data.forEach(filename => {
            const option = document.createElement("option");
            option.value = filename;
            option.textContent = filename.split('-').pop().split('.')[0];
            dropdown.appendChild(option);
          });
        });
    }

    // Funciones de dibujo
    function startDrawing(e) {
      drawing = true;
      currentPath = [];
      paths.push(currentPath);
      draw(e);
    }

    function draw(e) {
      if (!drawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX || e.touches[0].clientX) - rect.left;
      const y = (e.clientY || e.touches[0].clientY) - rect.top;

      ctx.globalAlpha = opacity;
      ctx.strokeStyle = color;
      ctx.lineWidth = size;
      ctx.lineCap = "round";

      if (currentPath.length === 0) {
        ctx.beginPath();
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
        ctx.stroke();
      }

      currentPath.push({ x, y });
    }

    function stopDrawing() {
      drawing = false;
      ctx.closePath();
    }

    // Deshacer y rehacer
    function undo() {
      if (paths.length > 0) {
        redoStack.push(paths.pop());
        redrawCanvas();
      }
    }

    function redo() {
      if (redoStack.length > 0) {
        paths.push(redoStack.pop());
        redrawCanvas();
      }
    }

    function redrawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      paths.forEach(path => {
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        path.forEach(point => ctx.lineTo(point.x, point.y));
        ctx.stroke();
      });
    }

    // Guardar imagen
    function save() {
      const link = document.createElement("a");
      link.download = "carton-bingo.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    // Cargar cart√≥n seleccionado
    function loadSelectedCarton() {
      const dropdown = document.getElementById("cartonDropdown");
      const selectedFile = dropdown.value;
      if (selectedFile) {
        baseImage.src = `cartones/${selectedFile}`;
        baseImage.onload = () => {
          scale = Math.min(canvas.width / baseImage.width, canvas.height / baseImage.height);
          imageWidth = baseImage.width * scale;
          imageHeight = baseImage.height * scale;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(baseImage, (canvas.width - imageWidth) / 2, (canvas.height - imageHeight) / 2, imageWidth, imageHeight);
        };
      }
    }

    // Alternar lista de cartones
    function toggleDropdown() {
      const dropdown = document.getElementById("cartonDropdown");
      dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
    }

    // Modo pantalla completa
    function toggleFullscreen() {
      const elem = document.documentElement;
      if (!document.fullscreenElement) {
        elem.requestFullscreen().catch(err => console.error(`Error al entrar en pantalla completa: ${err.message}`));
      } else {
        document.exitFullscreen();
      }
    }

    // Eventos de redimensionamiento
    window.addEventListener("resize", () => {
      setupCanvas();
      if (baseImage.src) {
        loadSelectedCarton();
      }
    });

    // Inicializaci√≥n
    setupCanvas();

    // Actualizar valores en tiempo real
    document.getElementById("colorPicker").addEventListener("input", e => color = e.target.value);
    document.getElementById("brushSizeSlider").addEventListener("input", e => {
      size = +e.target.value;
      document.getElementById("brushSizeValue").textContent = `${size}px`;
    });
    document.getElementById("opacityRange").addEventListener("input", e => opacity = +e.target.value);
  </script>
</body>
</html>
